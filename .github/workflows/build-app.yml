# ==============================================================================
#                 å°ç±³é’±åŒ…GUIåº”ç”¨ - å¤šå¹³å°æ„å»ºå·¥ä½œæµ
# ==============================================================================
#
# åŠŸèƒ½:
#   - è‡ªåŠ¨æ„å»ºæ ¸å¿ƒå¹³å°ï¼šWindowsã€macOSã€Androidã€iOS
#   - ä½¿ç”¨Fletå®˜æ–¹æ¨èçš„æ„å»ºå·¥å…·è¿›è¡Œæ‰“åŒ…
#   - è‡ªåŠ¨å‘å¸ƒæ„å»ºäº§ç‰©åˆ°GitHub Releases
#
# è§¦å‘æ¡ä»¶:
#   - æ¨é€æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»º
#   - æ‰‹åŠ¨è§¦å‘æ„å»º
#
# åŸºäºFletå®˜æ–¹æ¨èçš„GitHub Actionsé…ç½®
# å‚è€ƒ: https://github.com/ndonkoHenri/flet-github-action-workflows
# ==============================================================================

name: æ„å»ºå¤šå¹³å°Fletåº”ç”¨

# æƒé™è®¾ç½®
permissions:
  contents: write
  actions: read

# è§¦å‘å™¨é…ç½®
on:
  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆç”¨äºå‘å¸ƒç‰ˆæœ¬ï¼‰
  push:
    tags:
      - 'v*.*.*'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ä»»åŠ¡å®šä¹‰
jobs:
  build:
    name: æ„å»º ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    
    # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¿®å¤Windowså¹³å°Unicodeç¼–ç é—®é¢˜
    env:
      PYTHONIOENCODING: utf-8
      PYTHONLEGACYWINDOWSSTDIO: utf-8
    
    strategy:
      matrix:
        include:
          # æ¡Œé¢å¹³å°
          - os: windows-latest
            platform: windows
            flet_target: windows
            artifact_name: xiaomi-wallet-gui-windows
            artifact_ext: ".exe"
          - os: macos-latest
            platform: macos
            flet_target: macos
            artifact_name: xiaomi-wallet-gui-macos
            artifact_ext: ".app"
          # ç§»åŠ¨å¹³å°
          - os: ubuntu-latest
            platform: android
            flet_target: apk
            artifact_name: xiaomi-wallet-gui-android
            artifact_ext: ".apk"
          - os: macos-latest
            platform: ios
            flet_target: ipa
            artifact_name: xiaomi-wallet-gui-ios
            artifact_ext: ".ipa"
          # Web/PWAå¹³å°
          - os: ubuntu-latest
            platform: web
            flet_target: web
            artifact_name: xiaomi-wallet-gui-web
            artifact_ext: ".html"
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # è®¾ç½®Flutter SDK
      - name: è®¾ç½®Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          cache: true
      
      # å®‰è£…ç³»ç»Ÿä¾èµ– (ä»…Androidæ„å»ºéœ€è¦)
      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Android)
        if: matrix.platform == 'android'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-17-jdk \
            libgtk-3-dev \
            libblkid-dev \
            liblzma-dev \
            ninja-build \
            pkg-config \
            cmake \
            unzip \
            xz-utils \
            zip \
            curl \
            git
      
      # å®‰è£…Android SDK (ä»…Androidæ„å»ºéœ€è¦)
      - name: è®¾ç½®Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: '25.1.8937393'
      
      # æ¥å—Androidè®¸å¯è¯ (ä»…Androidæ„å»ºéœ€è¦)
      - name: æ¥å—Androidè®¸å¯è¯
        if: matrix.platform == 'android'
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
      
      # è®¾ç½®Androidç¯å¢ƒå˜é‡ (ä»…Androidæ„å»ºéœ€è¦)
      - name: è®¾ç½®Androidç¯å¢ƒå˜é‡
        if: matrix.platform == 'android'
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/build-tools/34.0.0" >> $GITHUB_PATH
      
      # è®¾ç½®Xcode (ä»…iOSæ„å»ºéœ€è¦)
      - name: è®¾ç½®Xcode
        if: matrix.platform == 'ios'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      # å®‰è£…Rosetta 2 (ä»…iOSæ„å»ºéœ€è¦ï¼ŒApple Silicon Mac)
      - name: å®‰è£…Rosetta 2
        if: matrix.platform == 'ios'
        run: |
          sudo softwareupdate --install-rosetta --agree-to-license || true
      
      # å®‰è£…CocoaPods (ä»…iOSæ„å»ºéœ€è¦)
      - name: å®‰è£…CocoaPods
        if: matrix.platform == 'ios'
        run: |
          sudo gem install cocoapods
      
      # å®‰è£…Pythonä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆåŒ…å«fletå’Œå…¶ä»–å¿…è¦ä¾èµ–ï¼‰
          pip install .
          # é¢å¤–å®‰è£…flet-cliç”¨äºæ„å»º
          pip install flet-cli
      
      # Flutterç¯å¢ƒæ£€æŸ¥å’Œä¿®å¤ (ä»…Androidæ„å»ºéœ€è¦)
      - name: Flutterç¯å¢ƒæ£€æŸ¥å’Œä¿®å¤
        if: matrix.platform == 'android'
        run: |
          # è¿è¡Œflutter doctoræ£€æŸ¥ç¯å¢ƒ
          flutter doctor -v
          
          # æ¸…ç†Flutterç¼“å­˜å¹¶é‡æ–°è·å–ä¾èµ–
          flutter clean
          flutter pub get
          
          # é¢„æ„å»ºFlutterå·¥å…·
          flutter precache --android
      
      # æ„å»ºåº”ç”¨ - Web/PWAå¹³å°
      - name: æ„å»ºWeb/PWAåº”ç”¨
        if: matrix.platform == 'web'
        run: |
          # ä½¿ç”¨flet publishå‘½ä»¤æ„å»ºWeb/PWAåº”ç”¨
          flet publish gui.py --app-name "å°ç±³é’±åŒ…åŠ©æ‰‹" --app-short-name "å°ç±³é’±åŒ…" --app-description "å°ç±³é’±åŒ…æ¯æ—¥ä»»åŠ¡è‡ªåŠ¨åŒ–åŠ©æ‰‹" --pwa-background-color "#ffffff" --pwa-theme-color "#FF6700" --distpath build/web

      # æ„å»ºåº”ç”¨ - å…¶ä»–å¹³å°
      - name: æ„å»ºéWebå¹³å°åº”ç”¨
        if: matrix.platform != 'web'
        run: |
          # ä½¿ç”¨å¸¸è§„buildå‘½ä»¤æ„å»ºå…¶ä»–å¹³å°åº”ç”¨
          flet build ${{ matrix.flet_target }} --verbose
      
      # åˆ›å»ºå‘å¸ƒç›®å½•
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          mkdir -p release
          
          # æ ¹æ®å¹³å°å¤åˆ¶æ„å»ºäº§ç‰©
          case "${{ matrix.platform }}" in
            "windows")
              cp -r build/windows/* release/ 2>/dev/null || true
              ;;
            "macos")
              cp -r build/macos/* release/ 2>/dev/null || true
              ;;
            "android")
              cp -r build/apk/* release/ 2>/dev/null || true
              find build -name "*.apk" -exec cp {} release/ \; 2>/dev/null || true
              ;;
            "ios")
              cp -r build/ipa/* release/ 2>/dev/null || true
              find build -name "*.ipa" -exec cp {} release/ \; 2>/dev/null || true
              ;;
            "web")
              cp -r build/web/* release/ 2>/dev/null || true
              ;;
          esac
          
          # æ·»åŠ READMEå’Œé…ç½®æ–‡ä»¶
          cp README.md release/ 2>/dev/null || true
          echo "[]" > release/xiaomiconfig.json
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: release/
          retention-days: 30
  
  # å‘å¸ƒä»»åŠ¡ï¼ˆä»…åœ¨æ¨é€æ ‡ç­¾æ—¶æ‰§è¡Œï¼‰
  release:
    name: åˆ›å»ºGitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      # æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          cd artifacts
          
          # æ¡Œé¢å¹³å°
          if [ -d "xiaomi-wallet-gui-windows" ]; then
            cd xiaomi-wallet-gui-windows
            zip -r ../xiaomi-wallet-gui-windows.zip .
            cd ..
          fi
          
          if [ -d "xiaomi-wallet-gui-macos" ]; then
            cd xiaomi-wallet-gui-macos
            tar -czf ../xiaomi-wallet-gui-macos.tar.gz .
            cd ..
          fi
          
          # ç§»åŠ¨å¹³å°
          if [ -d "xiaomi-wallet-gui-android" ]; then
            cd xiaomi-wallet-gui-android
            zip -r ../xiaomi-wallet-gui-android.zip .
            cd ..
          fi
          
          if [ -d "xiaomi-wallet-gui-ios" ]; then
            cd xiaomi-wallet-gui-ios
            zip -r ../xiaomi-wallet-gui-ios.zip .
            cd ..
          fi
          
          # Web/PWAå¹³å°
          if [ -d "xiaomi-wallet-gui-web" ]; then
            cd xiaomi-wallet-gui-web
            zip -r ../xiaomi-wallet-gui-web.zip .
            cd ..
          fi
      
      # åˆ›å»ºGitHub Release
      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/xiaomi-wallet-gui-windows.zip
            artifacts/xiaomi-wallet-gui-macos.tar.gz
            artifacts/xiaomi-wallet-gui-android.zip
            artifacts/xiaomi-wallet-gui-ios.zip
            artifacts/xiaomi-wallet-gui-web.zip
          body: |
            ## å°ç±³é’±åŒ…å¤šå¹³å°åº”ç”¨ ${{ github.ref_name }}
            
            ### ğŸ“± ç§»åŠ¨ç«¯ä¸‹è½½
            - **Androidç”¨æˆ·**: ä¸‹è½½ `xiaomi-wallet-gui-android.zip`ï¼Œè§£å‹åå®‰è£… `.apk` æ–‡ä»¶
            - **iOSç”¨æˆ·**: ä¸‹è½½ `xiaomi-wallet-gui-ios.zip`ï¼Œè§£å‹åé€šè¿‡Xcodeæˆ–TestFlightå®‰è£… `.ipa` æ–‡ä»¶
            
            ### ğŸ’» æ¡Œé¢ç«¯ä¸‹è½½
            - **Windowsç”¨æˆ·**: ä¸‹è½½ `xiaomi-wallet-gui-windows.zip`ï¼Œè§£å‹åè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
            - **macOSç”¨æˆ·**: ä¸‹è½½ `xiaomi-wallet-gui-macos.tar.gz`ï¼Œè§£å‹åè¿è¡Œ `.app` æ–‡ä»¶
            
            ### ğŸŒ Web/PWAç‰ˆæœ¬
            - **æ‰€æœ‰ç”¨æˆ·**: ä¸‹è½½ `xiaomi-wallet-gui-web.zip`ï¼Œè§£å‹åä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ `index.html` æ–‡ä»¶
            - **PWAå®‰è£…**: åœ¨æ”¯æŒPWAçš„æµè§ˆå™¨ä¸­ï¼ˆå¦‚Chromeã€Edgeï¼‰ï¼Œæ‰“å¼€åå¯ç‚¹å‡»åœ°å€æ ä¸­çš„å®‰è£…æŒ‰é’®å°†åº”ç”¨å®‰è£…åˆ°æ¡Œé¢æˆ–ç§»åŠ¨è®¾å¤‡
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. æ ¹æ®æ‚¨çš„è®¾å¤‡é€‰æ‹©å¯¹åº”ç‰ˆæœ¬ä¸‹è½½
            2. è§£å‹ä¸‹è½½çš„æ–‡ä»¶
            3. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œç¨‹åºä¼šåˆ›å»ºç©ºçš„ `xiaomiconfig.json` é…ç½®æ–‡ä»¶
            4. ä½¿ç”¨ç•Œé¢æ·»åŠ è´¦å·å¹¶æ‰§è¡Œä»»åŠ¡
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - è¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
            - é¦–æ¬¡ä½¿ç”¨éœ€è¦æ‰«ç ç™»å½•å°ç±³è´¦å·
            - é…ç½®æ–‡ä»¶ä¼šä¿å­˜åœ¨ç¨‹åºç›®å½•ä¸‹
            - Androidç‰ˆæœ¬éœ€è¦å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
            - iOSç‰ˆæœ¬å¯èƒ½éœ€è¦ä¿¡ä»»å¼€å‘è€…è¯ä¹¦
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}